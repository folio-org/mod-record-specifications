<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                   https://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">


  <changeSet id="MRSPECS-200@@update-table:specification_rule:add-metadata-fields" author="pavlo_smahin">
    <preConditions>
      <tableExists tableName="specification_rule"/>
    </preConditions>

    <comment>Add metadata fields to specification_rule table</comment>

    <addColumn tableName="specification_rule">
      <column name="created_by_user_id" type="UUID"/>
      <column name="created_date" type="DATETIME"/>
      <column name="updated_by_user_id" type="UUID"/>
      <column name="updated_date" type="DATETIME"/>
    </addColumn>
  </changeSet>

  <changeSet id="MRSPECS-200@@migrate:rule-to-specification-rule:metadata-fields" author="pavlo_smahin">
    <preConditions>
      <and>
        <tableExists tableName="specification_rule"/>
        <tableExists tableName="rule"/>
      </and>
    </preConditions>

    <comment>Migrate metadata from rule table to specification_rule table</comment>

    <sql>
      UPDATE specification_rule sr
      SET created_by_user_id = r.created_by_user_id,
          created_date = r.created_date,
          updated_by_user_id = r.updated_by_user_id,
          updated_date = r.updated_date
      FROM rule r
      WHERE sr.rule_id = r.id
    </sql>
  </changeSet>

  <changeSet id="MRSPECS-200@@update-table:specification_rule:add-not-null-constraints" author="pavlo_smahin">
    <preConditions>
      <tableExists tableName="specification_rule"/>
    </preConditions>

    <comment>Add NOT NULL constraints to metadata fields</comment>

    <addNotNullConstraint tableName="specification_rule" columnName="created_by_user_id" columnDataType="UUID"/>
    <addNotNullConstraint tableName="specification_rule" columnName="created_date" columnDataType="DATETIME"/>
    <addNotNullConstraint tableName="specification_rule" columnName="updated_by_user_id" columnDataType="UUID"/>
    <addNotNullConstraint tableName="specification_rule" columnName="updated_date" columnDataType="DATETIME"/>
  </changeSet>

</databaseChangeLog>